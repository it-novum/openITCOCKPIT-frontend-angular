<ng-container *transloco="let t">
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a [routerLink]="['/']">
                    <fa-icon [icon]="['fas', 'home']"></fa-icon>
                    {{ t('Home') }}
                </a></li>
            <li class="breadcrumb-item">
                <fa-icon [icon]="['fas', 'puzzle-piece']"></fa-icon>
                {{ t('Map Module') }}
            </li>
            <li class="breadcrumb-item">
                <a *oitcPermission="['mapmodule', 'maps', 'index']"
                   [routerLink]="['/', 'map_module', 'maps', 'index']">
                    <fa-icon [icon]="['fas', 'map-marker']"></fa-icon>
                    {{ t('Maps') }}
                </a>
            </li>
            <li aria-current="page" class="breadcrumb-item active">
                <fa-icon [icon]="['fas', 'edit']"></fa-icon>
                {{ t('Map editor') }}
            </li>
        </ol>
    </nav>

    <c-card class="mb-3">
        <c-card-header>
            <h5 cCardTitle>
                {{ t('Edit map:') }}

                <small class="fw-300" *ngIf="map">
                    {{ map.Map.name }}
                </small>
            </h5>

            <c-nav class="card-toolbar card-header-pills">

                <c-nav-item class="px-1">
                    <div class="checkbox small-checkbox-label me-1 mt-2">
                        <c-form-check>
                            <input
                                type="checkbox"
                                id="show_helplines"
                                cFormCheckInput
                                name="checkbox"
                                checked="checked"
                                [(ngModel)]="Mapeditor.helplines.enabled"
                                (ngModelChange)="onHelplinesChange()"
                            />
                            <label
                                cFormCheckLabel
                                for="show_helplines">
                                <i class="checkbox-primary"></i>
                                {{ t('Show help lines') }}
                            </label>
                        </c-form-check>
                    </div>
                </c-nav-item>
                <c-nav-item class="px-1">
                    <c-dropdown variant="btn-group">
                        <button cButton cDropdownToggle color="default" class="dropdown-button dropdown-btn ripple me-1"
                                size="xs" [caret]="true">
                            <span class="fa-stack helpline-stack-icon">
                                <i class="fas fa-grip-lines fa-stack-1x"></i>
                                <i class="fas fa-grip-lines-vertical"></i>
                            </span>
                            {{ t('Help lines distance') }} - {{ Mapeditor.helplines.size }}
                            <fa-icon [icon]="['fas', 'caret-down']"></fa-icon>
                        </button>
                        <ul cDropdownMenu>
                            <li *ngFor="let size of helplineSizes" (click)="changeHelplinesSize(size)">
                                <a cDropdownItem>{{ size }}x{{ size }}px</a>
                            </li>
                        </ul>
                    </c-dropdown>
                </c-nav-item>

                <c-nav-item class="px-1">
                    <button cButton
                            class="ripple me-1 shadow-0"
                            color="danger"
                            size="xs"
                            [hidden]="Mapeditor.synchronizeGridAndHelplinesSize"
                            (click)="onSynchronizeGridAndHelplinesSize(true)">
                        <fa-icon [icon]="['fas', 'arrow-left']" class="pe-1"></fa-icon>
                        <fa-icon [icon]="['fas', 'unlink']"></fa-icon>
                        {{ t('Change size automatically') }}
                        <fa-icon [icon]="['fas', 'arrow-right']" class="ps-1"></fa-icon>
                    </button>
                    <button cButton
                            class="ripple me-1 shadow-0"
                            color="success"
                            size="xs"
                            [hidden]="!Mapeditor.synchronizeGridAndHelplinesSize"
                            (click)="onSynchronizeGridAndHelplinesSize(false)">
                        <fa-icon [icon]="['fas', 'arrow-left']" class="pe-1"></fa-icon>
                        <fa-icon [icon]="['fas', 'unlink']"></fa-icon>
                        {{ t('Change size automatically') }}
                        <fa-icon [icon]="['fas', 'arrow-right']" class="ps-1"></fa-icon>
                    </button>
                </c-nav-item>

                <c-nav-item class="px-1">
                    <div class="checkbox small-checkbox-label me-1 mt-2">
                        <c-form-check>
                            <input
                                type="checkbox"
                                id="grid_enabled"
                                cFormCheckInput
                                name="checkbox"
                                checked="checked"
                                [(ngModel)]="Mapeditor.grid.enabled"
                                (ngModelChange)="onGridEnabledChange()"
                            />
                            <label
                                cFormCheckLabel
                                for="grid_enabled">
                                <i class="checkbox-primary"></i>
                                {{ t('Enable grid') }}
                            </label>
                        </c-form-check>
                    </div>
                </c-nav-item>
                <c-nav-item class="px-1">
                    <c-dropdown variant="btn-group">
                        <button cButton cDropdownToggle color="default" class="dropdown-button dropdown-btn ripple me-1"
                                size="xs" [caret]="true">
                            <fa-icon [icon]="['fas', 'th']"></fa-icon>
                            {{ t('Grid size') }} - {{ Mapeditor.grid.size }}
                            <fa-icon [icon]="['fas', 'caret-down']"></fa-icon>
                        </button>
                        <ul cDropdownMenu>
                            <li *ngFor="let size of gridSizes" (click)="changeGridSize(size)">
                                <a cDropdownItem>{{ size }}x{{ size }}px</a>
                            </li>
                        </ul>
                    </c-dropdown>
                </c-nav-item>

                <c-nav-item class="px-1">
                    <button [fallbackUrl]="['map_module', 'maps', 'index']" cButton class="ripple"
                            color="default"
                            oitcBackButton
                            size="xs">
                        <fa-icon [icon]="['fas', 'left-long']"></fa-icon>
                        {{ t('Back') }}
                    </button>
                </c-nav-item>

                <c-nav-item class="px-1" *ngIf="map">
                    <button *oitcPermission="['mapmodule', 'mapeditors', 'view']"
                            [routerLink]="['/', 'map_module', 'mapeditors', 'view', map.Map.id]" cButton class="ripple"
                            color="default" size="xs" class="me-1">
                        <fa-icon [icon]="['fas', 'eye']"></fa-icon>
                        {{ t('View') }}
                    </button>
                </c-nav-item>

            </c-nav>

        </c-card-header>
        <c-card-body>


            @if (map) {
                <!-- start map-editor -->
                <div id="map-editor" class="map-editor" #mapEditor>
                    <!-- start mainMapContainer -->
                    <div (click)="addNewObjectFunc($event)">
                        <oitc-map-canvas [helplines]="Mapeditor.helplines" [background]="map.Map.background"
                                         [isViewMode]="false" [currentDeletedItem]="currentDeletedItem">
                            <oitc-map-item *ngFor="let item of map.Mapitems" [item]="item" [refreshInterval]="0"
                                           [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                           [layers]="layers"
                                           (dblclick)="editItem(item)"
                                           (contextActionEvent)="onContextAction($event)"
                                           (dropItemEvent)="onDropItem($event)"
                                           [hidden]="!item.display">
                            </oitc-map-item>
                            <oitc-map-text *ngFor="let textItem of map.Maptexts" [item]="textItem"
                                           [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                           [layers]="layers"
                                           (contextActionEvent)="onContextAction($event)"
                                           (dropItemEvent)="onDropItem($event)"
                                           [hidden]="!textItem.display">
                            </oitc-map-text>
                            <oitc-map-line *ngFor="let lineItem of map.Maplines" [item]="lineItem" [refreshInterval]="0"
                                           [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                           [layers]="layers"
                                           (dblclick)="editLine(lineItem)"
                                           (contextActionEvent)="onContextAction($event)"
                                           (dropItemEvent)="onDropItem($event)"
                                           [hidden]="!lineItem.display">
                            </oitc-map-line>
                            <oitc-map-icon *ngFor="let iconItem of map.Mapicons" [item]="iconItem"
                                           [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                           [layers]="layers"
                                           (contextActionEvent)="onContextAction($event)"
                                           (dropItemEvent)="onDropItem($event)"
                                           [hidden]="!iconItem.display">
                            </oitc-map-icon>

                            <ng-container *ngFor="let gadgetItem of map.Mapgadgets">
                                @if (gadgetItem.gadget !== 'ServiceOutput') {
                                    <oitc-graph-item *ngIf="gadgetItem.gadget === 'RRDGraph'" [item]="gadgetItem"
                                                     [refreshInterval]="0"
                                                     [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                                     [layers]="layers"
                                                     (contextActionEvent)="onContextAction($event)"
                                                     (dropItemEvent)="onDropItem($event)"
                                                     (resizedEvent)="onResizeStop($event)"
                                                     [hidden]="!gadgetItem.display">
                                    </oitc-graph-item>
                                    <oitc-perfdata-text-item *ngIf="gadgetItem.gadget === 'Text'" [item]="gadgetItem"
                                                             [refreshInterval]="0"
                                                             [gridSize]="gridSize"
                                                             [gridEnabled]="Mapeditor.grid.enabled"
                                                             [layers]="layers"
                                                             (contextActionEvent)="onContextAction($event)"
                                                             (dropItemEvent)="onDropItem($event)"
                                                             (resizedEvent)="onResizeStop($event)"
                                                             [hidden]="!gadgetItem.display">
                                    </oitc-perfdata-text-item>
                                    <oitc-tacho-item *ngIf="gadgetItem.gadget === 'Tacho'" [item]="gadgetItem"
                                                     [refreshInterval]="0"
                                                     [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                                     [layers]="layers"
                                                     (contextActionEvent)="onContextAction($event)"
                                                     (dropItemEvent)="onDropItem($event)"
                                                     (resizedEvent)="onResizeStop($event)"
                                                     [hidden]="!gadgetItem.display">
                                    </oitc-tacho-item>
                                    <oitc-cylinder-item *ngIf="gadgetItem.gadget === 'Cylinder'" [item]="gadgetItem"
                                                        [refreshInterval]="0"
                                                        [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                                        [layers]="layers"
                                                        (contextActionEvent)="onContextAction($event)"
                                                        (dropItemEvent)="onDropItem($event)"
                                                        (resizedEvent)="onResizeStop($event)"
                                                        [hidden]="!gadgetItem.display">
                                    </oitc-cylinder-item>
                                    <oitc-trafficlight-item *ngIf="gadgetItem.gadget === 'TrafficLight'"
                                                            [item]="gadgetItem"
                                                            [refreshInterval]="0"
                                                            [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                                            [layers]="layers"
                                                            (contextActionEvent)="onContextAction($event)"
                                                            (dropItemEvent)="onDropItem($event)"
                                                            (resizedEvent)="onResizeStop($event)"
                                                            [hidden]="!gadgetItem.display">
                                    </oitc-trafficlight-item>
                                    <oitc-temperature-item *ngIf="gadgetItem.gadget === 'Temperature'"
                                                           [item]="gadgetItem"
                                                           [refreshInterval]="0"
                                                           [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                                           [layers]="layers"
                                                           (contextActionEvent)="onContextAction($event)"
                                                           (dropItemEvent)="onDropItem($event)"
                                                           (resizedEvent)="onResizeStop($event)"
                                                           [hidden]="!gadgetItem.display">
                                    </oitc-temperature-item>
                                }
                            </ng-container>
                            <ng-container *ngFor="let gadgetItem of map.Mapgadgets">
                                @if (gadgetItem.gadget === 'ServiceOutput') {
                                    <oitc-service-output-item *ngIf="gadgetItem.gadget === 'ServiceOutput'"
                                                              [item]="gadgetItem"
                                                              [refreshInterval]="0"
                                                              [gridSize]="gridSize"
                                                              [gridEnabled]="Mapeditor.grid.enabled"
                                                              [layers]="layers"
                                                              (contextActionEvent)="onContextAction($event)"
                                                              (dropItemEvent)="onDropItem($event)"
                                                              (resizedEvent)="onResizeStop($event)"
                                                              [hidden]="!gadgetItem.display">
                                    </oitc-service-output-item>
                                }
                            </ng-container>
                            <oitc-map-summary-item *ngFor="let summaryItem of map.Mapsummaryitems" [item]="summaryItem"
                                                   [refreshInterval]="0"
                                                   [gridSize]="gridSize" [gridEnabled]="Mapeditor.grid.enabled"
                                                   [layers]="layers"
                                                   (contextActionEvent)="onContextAction($event)"
                                                   (dropItemEvent)="onDropItem($event)"
                                                   (resizedEvent)="onResizeStop($event)"
                                                   [hidden]="!summaryItem.display">
                            </oitc-map-summary-item>
                        </oitc-map-canvas>
                    </div>
                    <!-- end mainMapContainer -->
                    <!-- start mapToolbar -->
                    <div id="mapToolbar" cdkDrag cdkDragBoundary=".map-editor">
                        <div id="mapToolsDragger" cdkDragHandle></div>

                        <div class="mapToolbarTool" title="{{ t('Add item') }}" (click)="addItem()">
                            <fa-icon [icon]="['fas', 'desktop']" size="lg"></fa-icon>
                        </div>

                        <div class="mapToolbarTool" title="{{ t('Add line') }}" (click)="addLine()">
                            <fa-icon [icon]="['fas', 'pencil-alt']" size="lg"></fa-icon>
                        </div>

                        <div class="mapToolbarTool" title="{{ t('Add summary status item') }}"
                             (click)="addSummaryItem()">
                            <fa-icon [icon]="['fas', 'dot-circle']" size="lg"></fa-icon>
                        </div>

                        <div class="mapToolbarLine"></div>

                        <div class="mapToolbarTool" title="{{ t('Add gadget') }}" (click)="addGadget()">
                            <fa-icon [icon]="['fas', 'tachometer-alt']" size="lg"></fa-icon>
                        </div>

                        <div class="mapToolbarLine"></div>

                        <div class="mapToolbarTool" title="{{ t('Change background image') }}"
                             (click)="openChangeMapBackgroundModal()">
                            <fa-icon [icon]="['fas', 'image']" size="lg"></fa-icon>
                        </div>

                        <div class="mapToolbarLine"></div>

                        <div class="mapToolbarTool" title="{{ t('Add stateless text') }}"
                             (click)="addText()">
                            <fa-icon [icon]="['fas', 'font']" size="lg"></fa-icon>
                        </div>

                        <div class="mapToolbarTool" title="{{ t('Add stateless icon') }}"
                             (click)="addIcon()">
                            <fa-icon [icon]="['fas', 'object-ungroup']" size="lg"></fa-icon>
                        </div>
                    </div>
                    <!-- end mapToolbar -->
                    <!-- start layersBox -->
                    <div id="layersBox" cdkDrag cdkDragBoundary=".map-editor">
                        <div id="layersBoxDragger" cdkDragHandle></div>
                        <div class="layersContainer">
                            <div class="mapLayer" *ngFor="let value of layers"
                                 [ngClass]="{ 'selectedLayer': value.key.toString() == defaultLayer }">
                                <span class="cursor-pointer"
                                      (click)="setDefaultLayer(value.key)">
                                    {{ value.value }}
                                </span>
                                <fa-icon [icon]="['fas', 'eye']" class="float-end pe-1 cursor-pointer"
                                         [hidden]="!visibleLayers['layer_'+ value.key]" (click)="hideLayer(value.key)"
                                         title="{{t('Click to hide layer')}}"></fa-icon>
                                <fa-icon [icon]="['fas', 'eye-slash']" class="float-end pe-1 cursor-pointer"
                                         [hidden]="visibleLayers['layer_'+ value.key]" (click)="showLayer(value.key)"
                                         title="{{t('Click to show layer')}}"></fa-icon>
                            </div>
                        </div>
                    </div>
                    <!-- end layersBox -->
                </div>
                <!-- end map-editor -->
            }

        </c-card-body>
    </c-card>


    <!-- Add/Edit map item modal -->
    <c-modal #addEditMapItemModal fullscreen="md" size="xl" id="addEditMapItemModal">
        <form cForm (ngSubmit)="saveItem()">
            <c-modal-header>
                <h5 cModalTitle>
                    <fa-icon [icon]="['fas', 'desktop']"></fa-icon>
                    {{ t('Add or edit map item') }}
                </h5>
                <div class="ms-auto">
                    <button cButton size="xs" class="ripple" color="default" (click)="uploadIconSet = true">
                        <fa-icon [icon]="['fas', 'upload']"></fa-icon>
                        {{ t('Upload iconset') }}
                    </button>
                    <button [cModalToggle]="addEditMapItemModal.id" cButtonClose></button>
                </div>
            </c-modal-header>
            <c-modal-body>

                <div [hidden]="uploadIconSet">
                    <c-row>
                        <c-col lg="12" class="form-group">
                            <div class="mb-3">
                                <label cLabel for="mapItemType">
                                    {{ t('Select object type') }}
                                </label>

                                <oitc-select
                                    name="mapItemType"
                                    id="mapItemType"
                                    optionValue="key"
                                    optionLabel="value"
                                    [(ngModel)]="currentItem.type"
                                    [options]="mapItemObjectTypes"
                                    (onChange)="onCurrentItemTypeObjectIdChange()"
                                    [appendTo]="addEditMapItemModal"
                                    oitcFormError [errors]="errors" errorField="type">
                                </oitc-select>
                                <oitc-form-feedback [errors]="errors" errorField="type"></oitc-form-feedback>
                            </div>
                        </c-col>
                    </c-row>
                    <c-row>
                        <c-col lg="12" class="form-group">
                            <div class="mb-3">
                                <label cLabel for="mapItemObjectId">
                                    {{ t('Select object') }}
                                </label>

                                <oitc-select
                                    name="mapItemObjectId"
                                    id="mapItemObjectId"
                                    optionValue="key"
                                    optionLabel="value"
                                    [(ngModel)]="currentItem.object_id"
                                    [options]="itemObjects"
                                    (onChange)="onCurrentItemTypeObjectIdChange()"
                                    [searchCallback]="loadMoreItemObjects"
                                    [appendTo]="addEditMapItemModal"
                                    oitcFormError [errors]="errors" errorField="object_id">
                                </oitc-select>
                                <oitc-form-feedback [errors]="errors" errorField="object_id"></oitc-form-feedback>
                            </div>
                        </c-col>
                    </c-row>
                    <c-row>
                        <div class="mb-3">
                            <c-col lg="12">
                                {{ t('Select iconset') }}
                                <oitc-required-icon></oitc-required-icon>
                            </c-col>
                            <c-col lg="12" *ngIf="iconsets">
                                <c-row style="max-height: 200px; overflow: auto;"
                                       [ngClass]="{'has-error-border': errors?.['iconset']}">
                                    <c-col xs="12" md="6" lg="2" *ngFor="let iconset of iconsets">
                                        <div class="card"
                                             style="height: 175px; width: 175px;margin-bottom:20px;"
                                             (click)="setCurrentIconset(iconset['MapUpload'].saved_name)"
                                             [ngClass]="{ 'selectedMapItem': iconset['MapUpload'].saved_name === currentItem.iconset }">
                                            <img class="mx-auto my-auto"
                                                 [src]="'/map_module/img/items/' + iconset['MapUpload'].saved_name + '/ok.png'">
                                        </div>
                                    </c-col>
                                </c-row>
                                <oitc-form-feedback [errors]="errors" errorField="iconset"></oitc-form-feedback>
                            </c-col>
                        </div>
                    </c-row>
                    <c-row>
                        <c-col lg="6">
                            <div class="mb-3">
                                <label cLabel for="addEditElPosX">
                                    {{ t('Position X') }}
                                </label>

                                <c-input-group>
                                    <span cInputGroupText>
                                        <fa-icon [icon]="['fas', 'map-marked-alt']"></fa-icon>
                                    </span>
                                    <input cFormControl
                                           required
                                           id="addEditElPosX"
                                           type="number"
                                           name="addEditElPosX"
                                           min="0"
                                           [placeholder]="'0' | transloco"
                                           [(ngModel)]="currentItem.x"
                                           oitcFormError [errors]="errors" errorField="x">
                                </c-input-group>
                                <oitc-form-feedback [errors]="errors" errorField="x"></oitc-form-feedback>
                            </div>
                        </c-col>
                        <c-col lg="6">
                            <div class="mb-3">
                                <label cLabel for="addEditElPosY">
                                    {{ t('Position Y') }}
                                </label>

                                <c-input-group>
                                    <span cInputGroupText>
                                        <fa-icon [icon]="['fas', 'map-marked-alt']"></fa-icon>
                                    </span>
                                    <input cFormControl
                                           required
                                           id="addEditElPosY"
                                           type="number"
                                           name="addEditElPosY"
                                           min="0"
                                           [placeholder]="'0' | transloco"
                                           [(ngModel)]="currentItem.y"
                                           oitcFormError [errors]="errors" errorField="y">
                                </c-input-group>
                                <oitc-form-feedback [errors]="errors" errorField="y"></oitc-form-feedback>
                            </div>
                        </c-col>
                    </c-row>
                    <c-row>
                        <c-col lg="10">
                            <div class="mb-3">
                                <label cLabel for="mapItemLayers">
                                    {{ t('Select layer') }}
                                </label>

                                <oitc-select
                                    name="mapItemLayers"
                                    id="mapItemLayers"
                                    optionValue="key"
                                    optionLabel="value"
                                    [(ngModel)]="currentItem.z_index"
                                    [options]="layers"
                                    [appendTo]="addEditMapItemModal"
                                    oitcFormError [errors]="errors" errorField="z_index">
                                </oitc-select>
                                <oitc-form-feedback [errors]="errors" errorField="z_index"></oitc-form-feedback>
                                <span class="help-block">
                                    {{ t('Layers could be used to stack items on a map. Empty layers will be deleted automatically.') }}
                                </span>
                            </div>
                        </c-col>
                        <c-col lg="2">
                            <button (click)="addNewLayer()" cButton class="ripple mt-4" style="width: 100%"
                                    color="default">
                                {{ t('Add new layer') }}
                            </button>
                        </c-col>
                    </c-row>
                    <c-row>
                        <c-col class="mb-3">
                            <c-form-check>
                                <input [(ngModel)]="currentItem.show_label" cFormCheckInput
                                       id="addEditElShowLabel"
                                       name="addEditElShowLabel"
                                       oitcFormError [errors]="errors" errorField="show_label"
                                       type="checkbox"/>
                                <label cFormCheckLabel for="addEditElShowLabel">
                                    {{ t('Show Label') }}
                                </label>
                            </c-form-check>
                            <oitc-form-feedback [errors]="errors" errorField="show_label"></oitc-form-feedback>
                        </c-col>
                    </c-row>
                    <c-row>
                        <div class="mb-3">
                            <label cLabel for="addEditElLabelPos">
                                {{ t('Label position') }}
                            </label>
                            <c-col lg="12" class="btn-toolbar">
                                <div class="btn-group me-2" role="group" id="addEditElLabelPos">
                                    <button (click)="currentItem.label_possition = 4" cButton class="ripple"
                                            color="default"
                                            [ngClass]="{ 'btn-primary': currentItem.label_possition === 4, 'btn-default': currentItem.label_possition !== 4 }">
                                        <fa-icon [icon]="['fas', 'arrow-circle-left']"></fa-icon>
                                        {{ t('Left') }}
                                    </button>
                                    <button (click)="currentItem.label_possition = 1" cButton class="ripple"
                                            color="default"
                                            [ngClass]="{ 'btn-primary': currentItem.label_possition === 1, 'btn-default': currentItem.label_possition !== 1 }">
                                        <fa-icon [icon]="['fas', 'arrow-circle-up']"></fa-icon>
                                        {{ t('Top') }}
                                    </button>
                                    <button (click)="currentItem.label_possition = 2" cButton class="ripple"
                                            color="default"
                                            [ngClass]="{ 'btn-primary': currentItem.label_possition === 2, 'btn-default': currentItem.label_possition !== 2 }">
                                        <fa-icon [icon]="['fas', 'arrow-circle-down']"></fa-icon>
                                        {{ t('Bottom') }}
                                    </button>
                                    <button (click)="currentItem.label_possition = 3" cButton class="ripple"
                                            color="default"
                                            [ngClass]="{ 'btn-primary': currentItem.label_possition === 3, 'btn-default': currentItem.label_possition !== 3 }">
                                        <fa-icon [icon]="['fas', 'arrow-circle-right']"></fa-icon>
                                        {{ t('Right') }}
                                    </button>
                                </div>
                            </c-col>
                        </div>
                    </c-row>
                </div>
                <div [hidden]="!uploadIconSet">
                    <c-col lg="12" class="pt-3">
                        <c-col lg="12">
                            {{ t('Upload new iconset (as .zip package)') }}
                        </c-col>
                        <c-col lg="12" class="text-info">
                            <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                            {{ t('Max allowed file size: ') }}
                            {{ maxUploadLimit?.string }}
                        </c-col>
                        <c-col lg="12">
                            <div id="iconsetDropzone"
                                 class="profileImg-dropzone dropzone dropzoneStyle iconset-dropzone">
                                <div class="dz-message">
                                    <fa-icon [icon]="['fas', 'cloud-upload-alt']" size="5x"
                                             class="mb-3 text-muted"></fa-icon>
                                    <br>
                                    <span class="text-uppercase"> {{ t('Drop files here or click to upload.') }} </span>
                                </div>
                            </div>
                        </c-col>
                    </c-col>
                    <c-col lg="12" class="pt-3 text-info">
                        <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                        {{ t('To upload a own iconset, you need to compress all required icons into a .zip archive.') }}
                        <br/>
                        {{ t('All icons needs to be PNG images. In addition you should follow the') }}
                        <a [routerLink]="['/', 'map_module', 'img', 'Map_Status_Colors_Guidelines.svg']">
                            {{ t('openITCOCKPIT color guidelines.') }}
                        </a>
                        <br/>
                        {{ t('Required icons: ') }}
                        <ng-container *ngFor="let requiredIcon of requiredIcons; last as isLast">
                            {{ requiredIcon }}
                            @if (!isLast) {
                                {{ ', ' }}
                            }
                        </ng-container>
                    </c-col>
                    <c-col lg="12" class="pt-3 text-end">
                        <button (click)="uploadIconSet = false" cButton class="ripple"
                                color="primary">
                            <fa-icon [icon]="['fas', 'arrow-left']"></fa-icon>
                            {{ t('Go back to settings') }}
                        </button>
                    </c-col>
                </div>

            </c-modal-body>
            <c-modal-footer>
                <button cButton color="danger" class="ripple me-auto" (click)="deleteItem()">
                    {{ t('Delete') }}
                </button>
                <button cButton color="success" type="submit" class="ripple">
                    {{ t('Save') }}
                </button>
                <button [cModalToggle]="addEditMapItemModal.id" cButton color="default" class="ripple">
                    {{ t('Close') }}
                </button>
            </c-modal-footer>
        </form>
    </c-modal>


    <!-- Add/Edit map line modal -->
    <c-modal #addEditMapLineModal fullscreen="md" size="xl" id="addEditMapLineModal">
        <form cForm (ngSubmit)="saveLine()">
            <c-modal-header>
                <h5 cModalTitle>
                    <fa-icon [icon]="['fas', 'pencil-alt']"></fa-icon>
                    {{ t('Add or edit line') }}
                </h5>
                <button [cModalToggle]="addEditMapLineModal.id" cButtonClose></button>
            </c-modal-header>
            <c-modal-body>

                <c-row>
                    <c-col lg="12" class="form-group">
                        <div class="mb-3">
                            <label cLabel for="mapLineType">
                                {{ t('Select object type') }}
                            </label>

                            <oitc-select
                                name="mapLineType"
                                id="mapLineType"
                                optionValue="key"
                                optionLabel="value"
                                [(ngModel)]="currentItem.type"
                                [options]="mapLineObjectTypes"
                                (onChange)="onCurrentItemTypeObjectIdChange()"
                                [appendTo]="addEditMapLineModal"
                                oitcFormError [errors]="errors" errorField="type">
                            </oitc-select>
                            <oitc-form-feedback [errors]="errors" errorField="type"></oitc-form-feedback>
                        </div>
                    </c-col>
                </c-row>
                <c-row *ngIf="currentItem.type !== 'stateless'">
                    <c-col lg="12" class="form-group">
                        <div class="mb-3">
                            <label cLabel for="mapLineObjectId">
                                {{ t('Select object') }}
                            </label>

                            <oitc-select
                                name="mapLineObjectId"
                                id="mapLineObjectId"
                                optionValue="key"
                                optionLabel="value"
                                [(ngModel)]="currentItem.object_id"
                                [options]="itemObjects"
                                (onChange)="onCurrentItemTypeObjectIdChange()"
                                [searchCallback]="loadMoreItemObjects"
                                [appendTo]="addEditMapLineModal"
                                oitcFormError [errors]="errors" errorField="object_id">
                            </oitc-select>
                            <oitc-form-feedback [errors]="errors" errorField="object_id"></oitc-form-feedback>
                        </div>
                    </c-col>
                </c-row>
                <c-row>
                    <c-col lg="6">
                        <div class="mb-3">
                            <label cLabel for="addEditLinePosStartX">
                                {{ t('Start X') }}
                            </label>

                            <c-input-group>
                                <span cInputGroupText>
                                    <fa-icon [icon]="['fas', 'map-marked-alt']"></fa-icon>
                                </span>
                                <input cFormControl
                                       required
                                       id="addEditLinePosStartX"
                                       type="number"
                                       name="addEditLinePosStartX"
                                       min="0"
                                       [placeholder]="'0' | transloco"
                                       [(ngModel)]="currentItem.startX"
                                       oitcFormError [errors]="errors" errorField="startX">
                            </c-input-group>
                            <oitc-form-feedback [errors]="errors" errorField="startX"></oitc-form-feedback>
                        </div>
                    </c-col>
                    <c-col lg="6">
                        <div class="mb-3">
                            <label cLabel for="addEditLinePosStartY">
                                {{ t('Start Y') }}
                            </label>

                            <c-input-group>
                                <span cInputGroupText>
                                    <fa-icon [icon]="['fas', 'map-marked-alt']"></fa-icon>
                                </span>
                                <input cFormControl
                                       required
                                       id="addEditLinePosStartY"
                                       type="number"
                                       name="addEditLinePosStartY"
                                       min="0"
                                       [placeholder]="'0' | transloco"
                                       [(ngModel)]="currentItem.startY"
                                       oitcFormError [errors]="errors" errorField="startY">
                            </c-input-group>
                            <oitc-form-feedback [errors]="errors" errorField="startY"></oitc-form-feedback>
                        </div>
                    </c-col>
                </c-row>
                <c-row>
                    <c-col lg="6">
                        <div class="mb-3">
                            <label cLabel for="addEditLinePosEndX">
                                {{ t('End X') }}
                            </label>

                            <c-input-group>
                                <span cInputGroupText>
                                    <fa-icon [icon]="['fas', 'map-marked-alt']"></fa-icon>
                                </span>
                                <input cFormControl
                                       required
                                       id="addEditLinePosEndX"
                                       type="number"
                                       name="addEditLinePosEndX"
                                       min="0"
                                       [placeholder]="'0' | transloco"
                                       [(ngModel)]="currentItem.endX"
                                       oitcFormError [errors]="errors" errorField="endX">
                            </c-input-group>
                            <oitc-form-feedback [errors]="errors" errorField="endX"></oitc-form-feedback>
                        </div>
                    </c-col>
                    <c-col lg="6">
                        <div class="mb-3">
                            <label cLabel for="addEditLinePosEndY">
                                {{ t('End Y') }}
                            </label>

                            <c-input-group>
                                <span cInputGroupText>
                                    <fa-icon [icon]="['fas', 'map-marked-alt']"></fa-icon>
                                </span>
                                <input cFormControl
                                       required
                                       id="addEditLinePosEndY"
                                       type="number"
                                       name="addEditLinePosEndY"
                                       min="0"
                                       [placeholder]="'0' | transloco"
                                       [(ngModel)]="currentItem.endY"
                                       oitcFormError [errors]="errors" errorField="endY">
                            </c-input-group>
                            <oitc-form-feedback [errors]="errors" errorField="endY"></oitc-form-feedback>
                        </div>
                    </c-col>
                </c-row>
                <c-row>
                    <c-col lg="10">
                        <div class="mb-3">
                            <label cLabel for="mapLineLayers">
                                {{ t('Select layer') }}
                            </label>

                            <oitc-select
                                name="mapLineLayers"
                                id="mapLineLayers"
                                optionValue="key"
                                optionLabel="value"
                                [(ngModel)]="currentItem.z_index"
                                [options]="layers"
                                [appendTo]="addEditMapLineModal"
                                oitcFormError [errors]="errors" errorField="z_index">
                            </oitc-select>
                            <oitc-form-feedback [errors]="errors" errorField="z_index"></oitc-form-feedback>
                            <span class="help-block">
                                {{ t('Layers could be used to stack items on a map. Empty layers will be deleted automatically.') }}
                            </span>
                        </div>
                    </c-col>
                    <c-col lg="2">
                        <button (click)="addNewLayer()" cButton class="ripple mt-4" style="width: 100%"
                                color="default">
                            {{ t('Add new layer') }}
                        </button>
                    </c-col>
                </c-row>
                <c-row>
                    <c-col class="mb-3">
                        <c-form-check>
                            <input [(ngModel)]="currentItem.show_label" cFormCheckInput
                                   id="addEditElShowLabel"
                                   name="addEditElShowLabel"
                                   oitcFormError [errors]="errors" errorField="show_label"
                                   type="checkbox"/>
                            <label cFormCheckLabel for="addEditElShowLabel">
                                {{ t('Show Label') }}
                            </label>
                        </c-form-check>
                        <oitc-form-feedback [errors]="errors" errorField="show_label"></oitc-form-feedback>
                    </c-col>
                </c-row>

            </c-modal-body>
            <c-modal-footer>
                <button cButton color="danger" class="ripple me-auto" (click)="deleteLine()">
                    {{ t('Delete') }}
                </button>
                <button cButton color="success" type="submit" class="ripple">
                    {{ t('Save') }}
                </button>
                <button [cModalToggle]="addEditMapLineModal.id" cButton color="default" class="ripple">
                    {{ t('Close') }}
                </button>
            </c-modal-footer>
        </form>
    </c-modal>


    <!-- Add/Edit map gadget modal -->
    <c-modal #addEditMapGadgetModal fullscreen="md" size="xl" id="addEditMapGadgetModal">
        <form cForm (ngSubmit)="saveGadget()">
            <c-modal-header>
                <h5 cModalTitle>
                    <fa-icon [icon]="['fas', 'tachometer-alt']"></fa-icon>
                    {{ t('Add or edit gadget') }}
                </h5>
                <button [cModalToggle]="addEditMapGadgetModal.id" cButtonClose></button>
            </c-modal-header>
            <c-modal-body>

                <c-row>
                    <c-col lg="12" class="form-group">
                        <div class="mb-3">
                            <label cLabel for="mapGadgetObjectId">
                                {{ t('Select service') }}
                            </label>

                            <oitc-select
                                name="mapGadgetObjectId"
                                id="mapGadgetObjectId"
                                optionValue="key"
                                optionLabel="value"
                                [(ngModel)]="currentItem.object_id"
                                [options]="itemObjects"
                                (onChange)="onCurrentItemTypeObjectIdChange()"
                                [searchCallback]="loadMoreItemObjects"
                                [appendTo]="addEditMapGadgetModal"
                                oitcFormError [errors]="errors" errorField="object_id">
                            </oitc-select>
                            <oitc-form-feedback [errors]="errors" errorField="object_id"></oitc-form-feedback>
                        </div>
                    </c-col>
                </c-row>
                <c-row>
                    <div class="mb-3">
                        <c-col lg="12">
                            {{ t('Select gadget type') }}
                            <oitc-required-icon></oitc-required-icon>
                        </c-col>
                        <c-col lg="12" *ngIf="iconsets">
                            <c-row style="max-height: 200px; overflow: auto;"
                                   [ngClass]="{'has-error-border': errors?.['iconset']}">
                                <ng-container *ngFor="let gadget of gadgetPreviews">
                                    <c-col xs="12" md="6" lg="2">
                                        <div class="card"
                                             style="height: 175px; width: 175px"
                                             (click)="currentItem.gadget = gadget.name; currentItem.size_x = null; currentItem.size_y = null;"
                                             [ngClass]="{ 'selectedMapItem': currentItem.gadget === gadget.name }">
                                            <img class="mx-auto my-auto"
                                                 [src]="getSanitizedGadgetPreviewUrl(gadget.preview)">
                                        </div>
                                    </c-col>
                                </ng-container>
                            </c-row>
                            <oitc-form-feedback [errors]="errors" errorField="iconset"></oitc-form-feedback>
                        </c-col>
                    </div>
                </c-row>
                <c-row [hidden]="!(currentItem.gadget !== 'TrafficLight' && currentItem.gadget !== 'ServiceOutput')">
                    <c-col lg="12" class="form-group">
                        <div class="mb-3">
                            <label cLabel for="mapGadgetMetric">
                                {{ t('Select metric') }}
                            </label>

                            <oitc-select
                                name="mapGadgetMetric"
                                id="mapGadgetMetric"
                                optionValue="key"
                                optionLabel="value"
                                [(ngModel)]="currentItem.metric"
                                [options]="metrics"
                                [appendTo]="addEditMapGadgetModal"
                                oitcFormError [errors]="errors" errorField="metric">
                            </oitc-select>
                            <oitc-form-feedback [errors]="errors" errorField="metric"></oitc-form-feedback>
                        </div>
                    </c-col>
                </c-row>
                <c-row [hidden]="!(currentItem.gadget == 'ServiceOutput')">
                    <c-col lg="12">
                        <div class="mb-3">
                            <label cLabel for="addEditGadgetFontSize">
                                {{ t('Font size') }}
                            </label>

                            <c-input-group>
                                <span cInputGroupText>
                                    <fa-icon [icon]="['fas', 'font']"></fa-icon>
                                </span>
                                <input cFormControl
                                       required
                                       id="addEditGadgetFontSize"
                                       type="number"
                                       name="addEditGadgetFontSize"
                                       min="1"
                                       [placeholder]="'13' | transloco"
                                       [(ngModel)]="currentItem.font_size"
                                       oitcFormError [errors]="errors" errorField="font_size">
                            </c-input-group>
                            <oitc-form-feedback [errors]="errors" errorField="font_size"></oitc-form-feedback>
                        </div>
                    </c-col>
                </c-row>
                <c-row>
                    <c-col lg="6">
                        <div class="mb-3">
                            <label cLabel for="addEditElPosX">
                                {{ t('Position X') }}
                            </label>

                            <c-input-group>
                                <span cInputGroupText>
                                    <fa-icon [icon]="['fas', 'map-marked-alt']"></fa-icon>
                                </span>
                                <input cFormControl
                                       required
                                       id="addEditElPosX"
                                       type="number"
                                       name="addEditElPosX"
                                       min="0"
                                       [placeholder]="'0' | transloco"
                                       [(ngModel)]="currentItem.x"
                                       oitcFormError [errors]="errors" errorField="x">
                            </c-input-group>
                            <oitc-form-feedback [errors]="errors" errorField="x"></oitc-form-feedback>
                        </div>
                    </c-col>
                    <c-col lg="6">
                        <div class="mb-3">
                            <label cLabel for="addEditElPosY">
                                {{ t('Position Y') }}
                            </label>

                            <c-input-group>
                                <span cInputGroupText>
                                    <fa-icon [icon]="['fas', 'map-marked-alt']"></fa-icon>
                                </span>
                                <input cFormControl
                                       required
                                       id="addEditElPosY"
                                       type="number"
                                       name="addEditElPosY"
                                       min="0"
                                       [placeholder]="'0' | transloco"
                                       [(ngModel)]="currentItem.y"
                                       oitcFormError [errors]="errors" errorField="y">
                            </c-input-group>
                            <oitc-form-feedback [errors]="errors" errorField="y"></oitc-form-feedback>
                        </div>
                    </c-col>
                </c-row>
                <c-row>
                    <c-col lg="6">
                        <div class="mb-3">
                            <label cLabel for="addEditGadgetWidth">
                                {{ t('Width') }}
                            </label>

                            <c-input-group>
                                <span cInputGroupText>
                                    <fa-icon [icon]="['fas', 'arrows-alt-h']"></fa-icon>
                                </span>
                                <input cFormControl
                                       required
                                       id="addEditGadgetWidth"
                                       type="number"
                                       name="addEditGadgetWidth"
                                       min="0"
                                       [placeholder]="'0' | transloco"
                                       [(ngModel)]="currentItem.size_x"
                                       oitcFormError [errors]="errors" errorField="size_x">
                            </c-input-group>
                            <oitc-form-feedback [errors]="errors" errorField="size_x"></oitc-form-feedback>
                            <span class="help-block">
                                {{ t('Keep blank for default width') }}
                            </span>
                        </div>
                    </c-col>
                    <c-col lg="6">
                        <div class="mb-3">
                            <label cLabel for="addEditGadgetHeight">
                                {{ t('Height') }}
                            </label>

                            <c-input-group>
                                <span cInputGroupText>
                                    <fa-icon [icon]="['fas', 'arrows-alt-v']"></fa-icon>
                                </span>
                                <input cFormControl
                                       required
                                       id="addEditGadgetHeight"
                                       type="number"
                                       name="addEditGadgetHeight"
                                       min="0"
                                       [placeholder]="'0' | transloco"
                                       [(ngModel)]="currentItem.size_y"
                                       oitcFormError [errors]="errors" errorField="size_y">
                            </c-input-group>
                            <oitc-form-feedback [errors]="errors" errorField="size_y"></oitc-form-feedback>
                            <span class="help-block">
                                {{ t('Keep blank for default width') }}
                            </span>
                        </div>
                    </c-col>
                </c-row>
                <c-row>
                    <c-col lg="10">
                        <div class="mb-3">
                            <label cLabel for="mapGadgetLayers">
                                {{ t('Select layer') }}
                            </label>

                            <oitc-select
                                name="mapGadgetLayers"
                                id="mapGadgetLayers"
                                optionValue="key"
                                optionLabel="value"
                                [(ngModel)]="currentItem.z_index"
                                [options]="layers"
                                [appendTo]="addEditMapGadgetModal"
                                oitcFormError [errors]="errors" errorField="z_index">
                            </oitc-select>
                            <oitc-form-feedback [errors]="errors" errorField="z_index"></oitc-form-feedback>
                            <span class="help-block">
                                {{ t('Layers could be used to stack items on a map. Empty layers will be deleted automatically.') }}
                            </span>
                        </div>
                    </c-col>
                    <c-col lg="2">
                        <button (click)="addNewLayer()" cButton class="ripple mt-4" style="width: 100%"
                                color="default">
                            {{ t('Add new layer') }}
                        </button>
                    </c-col>
                </c-row>
                <c-row>
                    <c-col class="mb-3">
                        <c-form-check>
                            <input [(ngModel)]="currentItem.show_label" cFormCheckInput
                                   id="addEditElShowLabel"
                                   name="addEditElShowLabel"
                                   oitcFormError [errors]="errors" errorField="show_label"
                                   type="checkbox"/>
                            <label cFormCheckLabel for="addEditElShowLabel">
                                {{ t('Show Label') }}
                            </label>
                        </c-form-check>
                        <oitc-form-feedback [errors]="errors" errorField="show_label"></oitc-form-feedback>
                    </c-col>
                </c-row>

            </c-modal-body>
            <c-modal-footer>
                <button cButton color="danger" class="ripple me-auto" (click)="deleteGadget()">
                    {{ t('Delete') }}
                </button>
                <button cButton color="success" type="submit" class="ripple">
                    {{ t('Save') }}
                </button>
                <button [cModalToggle]="addEditMapGadgetModal.id" cButton color="default" class="ripple">
                    {{ t('Close') }}
                </button>
            </c-modal-footer>
        </form>
    </c-modal>


</ng-container>
