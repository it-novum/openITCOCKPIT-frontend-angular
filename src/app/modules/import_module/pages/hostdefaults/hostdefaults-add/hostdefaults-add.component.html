<ng-container *transloco="let t">
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a [routerLink]="['/']">
                    <fa-icon [icon]="['fas', 'home']"></fa-icon>
                    {{ t('Home') }}
                </a>
            </li>
            <li class="breadcrumb-item">
                <fa-icon [icon]="['fas', 'puzzle-piece']"></fa-icon>
                {{ t('Import Module') }}
            </li>
            <li class="breadcrumb-item">
                <a *oitcPermission="['importmodule','HostDefaults', 'index']"
                   [routerLink]="['/', 'import_module', 'HostDefaults', 'index']">
                    <fa-icon [icon]="['fas', 'tasks']"></fa-icon>
                    {{ t('Host defaults') }}
                </a>
            </li>
            <li aria-current="page" class="breadcrumb-item active">
                <fa-icon [icon]="['fas', 'plus']"></fa-icon>
                {{ t('Add host defaults') }}
            </li>
        </ol>
    </nav>
    <form cForm (ngSubmit)="submit()" autocomplete="off">
        <c-card class="mb-3">
            <c-card-header>
                <h5 cCardTitle>{{ t('Create new host defaults') }}</h5>
                <c-nav class="card-toolbar card-header-pills">
                    <c-nav-item class="px-1">
                        <button [fallbackUrl]="['import_module', 'HostDefaults', 'index']" cButton class="ripple"
                                color="default"
                                oitcBackButton
                                size="xs">
                            <fa-icon [icon]="['fas', 'left-long']"></fa-icon>
                            {{ t('Back') }}
                        </button>
                    </c-nav-item>
                </c-nav>
            </c-card-header>
            <c-card-body>
                <div class="row">
                    <div class="col-12">
                        <c-alert color="info">
                            <h4 cAlertHeading>
                                <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                                {{ t('What are host defaults?') }}
                            </h4>
                            <p>
                                {{ t('Define defaults like which Container and services should assigned to imported hosts, depending on the used data source (Importer).') }}
                            </p>
                        </c-alert>
                    </div>
                </div>
                <c-alert color="warning" *ngIf="showRootAlert">
                    <h4 cAlertHeading>
                        <fa-icon [icon]="['fas', 'exclamation-triangle']"></fa-icon>
                        {{ t('/root container selected!') }}
                    </h4>
                    <p>{{ t('Choosing a tenant container is recommended for later permission purposes') }}</p>
                </c-alert>
                <div class="mb-3">
                    <label cLabel for="container">
                        {{ t('Container') }}
                        <oitc-required-icon></oitc-required-icon>
                    </label>
                    <oitc-select
                        name="container"
                        id="container"
                        optionValue="key"
                        optionLabel="value"
                        [options]="containers"
                        [(ngModel)]="post.container_id"
                        [debounce]="true"
                        (onChange)="onContainerChange()">
                    </oitc-select>
                    <div *ngIf="!post.container_id" class="text-warning-glow pt-1">
                        {{ t('Please select a container.') }}
                    </div>
                    <div *ngIf="post.container_id === ROOT_CONTAINER"
                         class="help-block text-warning text-warning-glow">
                        <fa-icon [icon]="['fas', 'exclamation-triangle']"></fa-icon>
                        {{ t('Hosts in /root can\'t be moved to other containers later') }}
                    </div>
                    <oitc-form-feedback [errors]="errors" errorField="container_id"></oitc-form-feedback>
                </div>
                <div class="mb-3">
                    <label cLabel for="HostdefaultName">
                        {{ t('Name') }}
                        <oitc-required-icon></oitc-required-icon>
                    </label>
                    <input cFormControl id="HostdefaultName" required type="text"
                           name="name"
                           [(ngModel)]="post.name"
                           oitcFormError errorField="name">
                    <oitc-form-feedback [errors]="errors" errorField="name"></oitc-form-feedback>
                </div>
                <div class="mb-3">
                    <label cLabel for="HostdefaultDescription">
                        {{ t('Description') }}
                    </label>
                    <input cFormControl id="HostdefaultDescription" required type="text"
                           name="description"
                           [(ngModel)]="post.description"
                           oitcFormError errorField="description">
                </div>

                <c-container
                    [fluid]="true" class="shadow-sm px-2 pb-4 mb-4 bg-body rounded">
                    <fieldset>
                        <legend class="small fieldset-legend-border-bottom">
                            <h4>
                                <fa-icon [icon]="['fas', 'desktop']"></fa-icon>
                                {{ t('Host details ') }}
                            </h4>
                            <div class="help-block">
                                {{ t('Predefined host settings that are automatically assigned when hosts are imported.') }}
                            </div>
                        </legend>
                        <c-row>
                            <c-col>
                                <div class="mb-3">
                                    <label cLabel for="host_container">
                                        {{ t('Host container') }}
                                        <oitc-required-icon></oitc-required-icon>
                                    </label>
                                    <oitc-select
                                        name="host_container"
                                        id="host_container"
                                        optionValue="key"
                                        optionLabel="value"
                                        [disabled]="true"
                                        [options]="containers"
                                        placeholder="{{ t('Will be automatically selected') }}"
                                        [(ngModel)]="post.container_id">
                                    </oitc-select>
                                </div>
                                <div class="mb-3">
                                    <label cLabel for="HostTemplate">
                                        <oitc-label-link
                                            [objectId]="post.hosttemplate_id"
                                            [route]="'/hosttemplates/edit'"
                                            [permissions]="'hosttemplates.edit'">
                                            {{ t('Host template') }}
                                            <oitc-required-icon></oitc-required-icon>
                                        </oitc-label-link>
                                    </label>
                                    <oitc-select
                                        name="hosttemplate"
                                        id="HostTemplate"
                                        optionValue="key"
                                        optionLabel="value"
                                        placeholder="{{ t('Please choose') }}"
                                        [options]="hosttemplates"
                                        [(ngModel)]="post.hosttemplate_id"
                                        oitcFormError [errors]="errors" errorField="hosttemplates">
                                    </oitc-select>
                                    <div *ngIf="!post.container_id" class="text-warning-glow pt-1">
                                        {{ t('Please select a host template.') }}
                                    </div>
                                    <oitc-form-feedback [errors]="errors"
                                                        errorField="hosttemplate_id"></oitc-form-feedback>
                                </div>

                                <div class="mb-3">
                                    <label cLabel for="HostSharingContainer">
                                        {{ t('Shared containers') }}
                                    </label>

                                    <oitc-multi-select
                                        name="HostSharingContainer"
                                        id="HostSharingContainer"
                                        optionValue="key"
                                        optionLabel="value"
                                        [(ngModel)]="post.hostdefaults_to_containers_sharing._ids"
                                        [options]="sharingContainers"
                                        oitcFormError [errors]="errors" errorField="hosts_to_containers_sharing">
                                    </oitc-multi-select>

                                    <oitc-form-feedback [errors]="errors" errorField="hosts_to_containers_sharing">
                                    </oitc-form-feedback>
                                </div>
                                @if (PermissionsService.hasModuleObservable('DistributeModule')|async) {
                                    <div class="mb-3">
                                        <label cLabel for="SatellitesSelect">
                                            <oitc-label-link
                                                [objectId]="post.satellite_id"
                                                [route]="'/distribute_module/satellites/edit'"
                                                [permissions]="'DistributeModule.satellites.edit'">
                                                {{ t('Satellite') }}
                                            </oitc-label-link>
                                        </label>

                                        <oitc-select
                                            name="SatellitesSelect"
                                            id="SatellitesSelect"
                                            optionValue="key"
                                            optionLabel="value"
                                            [(ngModel)]="post.satellite_id"
                                            [options]="satellites"
                                            oitcFormError [errors]="errors" errorField="satellite_id">
                                        </oitc-select>
                                        <oitc-form-feedback [errors]="errors"
                                                            errorField="satellite_id"></oitc-form-feedback>
                                    </div>
                                }
                            </c-col>
                        </c-row>
                    </fieldset>
                </c-container>
                <!-- Service templates -->
                <c-container
                    [fluid]="true" class="shadow-sm mt-2 pb-2 bg-body rounded">
                    <fieldset>
                        <legend class="small fieldset-legend-border-bottom">
                            <h4>
                                <div class="icon-stack">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                    <i class="fas fa-font fa-xs text-primary cornered cornered-lr"></i>
                                </div>
                                {{ t('Service templates matches') }}
                                <span class="italic text-info">{{ t(' (optional):') }}</span>
                            </h4>
                            <div class="help-block">
                                {{ t('If the match is successful, these service templates are assigned to the imported hosts.') }}
                            </div>
                        </legend>
                        @for (match of post.hostdefaults_to_servicetemplates; track $index) {
                            <c-row>
                                <c-col [xs]="12" [md]="12" [lg]="2">
                                    <c-input-group>
                                        <span cInputGroupText class="bg-primary text-white">
                                            <fa-icon [icon]="['fas', 'equals']"></fa-icon>
                                        </span>
                                        <oitc-select
                                            class="flex-1"
                                            name="hd_field_st_{{$index}}"
                                            id="hd_field_st_{{$index}}"
                                            optionValue="key"
                                            optionLabel="value"
                                            [options]="matchFields"
                                            [(ngModel)]="post.hostdefaults_to_servicetemplates[$index].field"
                                            [showClear]="false">
                                        </oitc-select>
                                    </c-input-group>
                                    <div class="help-block">
                                        {{ t('Field to match') }}
                                    </div>
                                </c-col>
                                <c-col [xs]="12" [md]="12" [lg]="4">
                                    <c-input-group>
                                        <span cInputGroupText class="bg-info text-white">
                                            <fa-icon [icon]="['fas', 'filter']"></fa-icon>
                                        </span>
                                        <input type="text" cFormControl
                                               name="hd_regex_st{{$index}}"
                                               id="hd_regex_st{{$index}}"
                                               oitcDebounce
                                               placeholder="{{ t('RegEx') }}"
                                               [(ngModel)]="post.hostdefaults_to_servicetemplates[$index].regex"
                                        />
                                        <span cInputGroupText>
                                            <oitc-regex-helper-tooltip></oitc-regex-helper-tooltip>
                                        </span>
                                    </c-input-group>
                                    <div class="help-block">
                                        {{ t('RegEx that needs to match') }}
                                    </div>
                                </c-col>
                                <c-col [xs]="12" [md]="12" [lg]="4">
                                    <c-input-group>
                                        <span cInputGroupText class="bg-default">
                                            <fa-icon [icon]="['fas', 'pen-to-square']"></fa-icon>
                                        </span>
                                        <oitc-select
                                            class="flex-1"
                                            name="hd_field_st_{{$index}}"
                                            id="hd_field_st_{{$index}}"
                                            optionValue="key"
                                            optionLabel="value"
                                            [options]="servicetemplates"
                                            [(ngModel)]="post.hostdefaults_to_servicetemplates[$index].servicetemplate_id"
                                            [showClear]="false">
                                        </oitc-select>
                                    </c-input-group>
                                    <div class="help-block">
                                        {{ t('Service template to assign on match') }}
                                    </div>
                                </c-col>
                                <c-col [xs]="12" [md]="12" [lg]="1">
                                    <button class="btn btn-danger ripple waves-effect waves-themed"
                                            type="button"
                                            (click)="removeMatchServicetemplate(match.index)">
                                        <fa-icon [icon]="['fas', 'trash']" size="lg"></fa-icon>
                                    </button>
                                </c-col>
                            </c-row>
                        }
                        <c-row>
                            <c-col>
                            </c-col>
                            <c-col class="text-end">
                                <button cButton class="ripple" color="success"
                                        *ngIf="servicetemplates.length > 0" type="button"
                                        [disabled]="!servicetemplates.length"
                                        (click)="addMatchServicetemplate()">
                                    <fa-icon [icon]="['fas', 'plus']"></fa-icon>
                                    {{ t('Add') }}
                                </button>
                            </c-col>
                        </c-row>
                    </fieldset>
                </c-container>
                <!-- Service template groups -->
                <c-container
                    [fluid]="true" class="shadow-sm mt-2 pb-2 bg-body rounded">
                    <fieldset>
                        <legend class="small fieldset-legend-border-bottom">
                            <h4>
                                <div class="icon-stack">
                                    <i class="fa-solid fa-object-group"></i>
                                    <i class="fas fa-font fa-xs text-primary cornered cornered-lr"></i>
                                </div>
                                {{ t('Service template groups matches') }}
                                <span class="italic text-info">{{ t(' (optional):') }}</span>
                            </h4>
                            <div class="help-block">
                                {{ t('If the match is successful, these service template groups are assigned to the imported hosts.') }}
                            </div>
                        </legend>
                        <c-row>
                            <c-col>
                            </c-col>
                        </c-row>
                    </fieldset>
                </c-container>
                <!-- Agent Checks -->
                <c-container
                    [fluid]="true" class="shadow-sm mt-2 pb-2 bg-body rounded">
                    <fieldset>
                        <legend class="small fieldset-legend-border-bottom">
                            <h4>
                                <div class="icon-stack">
                                    <i class="fa-solid fa-user-secret"></i>
                                    <i class="fas fa-cogs fa-xs text-primary cornered cornered-lr"></i>
                                </div>
                                {{ t('Agent checks matches') }}
                                <span class="italic text-info">{{ t(' (optional):') }}</span>
                            </h4>
                            <div class="help-block">
                                {{ t('If the match is successful, these agent checks are assigned to the imported hosts.') }}
                            </div>
                        </legend>
                        <c-row>
                            <c-col>
                            </c-col>
                        </c-row>
                    </fieldset>
                </c-container>
                <!-- External Monitoring Checks -->
                <c-container
                    [fluid]="true" class="shadow-sm mt-2 pb-2 bg-body rounded">
                    <fieldset>
                        <legend class="small fieldset-legend-border-bottom">
                            <h4>
                                <div class="icon-stack">
                                    <i class="fa-solid fa-tower-observation"></i>
                                    <i class="fas fa-cog fa-xs text-primary cornered cornered-lr"></i>
                                </div>
                                {{ t('External Monitoring Checks') }}
                                <span class="italic text-info">{{ t(' (optional):') }}</span>
                            </h4>
                            <div class="help-block">
                                {{ t('If the match is successful, these service templates are assigned to the imported hosts.') }}
                            </div>
                        </legend>
                        <c-row>
                            <c-col>
                            </c-col>
                        </c-row>
                    </fieldset>
                </c-container>
            </c-card-body>
            <c-card-footer class="text-end">
                <label class="me-2">
                    <input cFormCheckInput type="checkbox" name="createAnother"
                           [(ngModel)]="createAnother">
                    {{ t('Create another') }}
                </label>
                <button cButton class="ripple" color="primary" type="submit">
                    {{ t('Create host defaults') }}
                </button>
                <button [fallbackUrl]="['import_module','Hostdefaults', 'index']" cButton class="ms-1 ripple"
                        color="default" oitcBackButton type="button">
                    {{ t('Cancel') }}
                </button>
            </c-card-footer>
        </c-card>
    </form>
</ng-container>
